# helpers/ai_logs_manager.py

import pandas as pd
import os
from datetime import datetime

class AILogsManager:
    """
    Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ.
    ÙŠØªÙ… Ø­ÙØ¸ ÙƒÙ„ Ø§Ø³ØªÙØ³Ø§Ø± ÙˆØ§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©.
    """
    def __init__(self, file_path="data/AI_Analysis_Logs.csv"):
        self.file_path = file_path
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØŒ ÙˆØ¥Ù†Ø´Ø§Ø¤Ù‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
        if not os.path.exists(self.file_path):
            self.create_empty_log()

    def create_empty_log(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù CSV ÙØ§Ø±Øº Ù…Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"""
        df = pd.DataFrame(columns=[
            "timestamp", "role", "query", "response",
            "reference", "example", "notes"
        ])
        df.to_csv(self.file_path, index=False, encoding="utf-8-sig")

    def log_interaction(self, role, query, response, reference="", example="", notes=""):
        """Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªÙØ§Ø¹Ù„"""
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        new_entry = {
            "timestamp": timestamp,
            "role": role,
            "query": query,
            "response": response,
            "reference": reference,
            "example": example,
            "notes": notes
        }
        df = pd.read_csv(self.file_path, encoding="utf-8-sig")
        df = pd.concat([df, pd.DataFrame([new_entry])], ignore_index=True)
        df.to_csv(self.file_path, index=False, encoding="utf-8-sig")

    def load_logs(self):
        """ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©"""
        return pd.read_csv(self.file_path, encoding="utf-8-sig")

    def search_logs(self, keyword):
        """Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø­Ø³Ø¨ ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ©"""
        df = self.load_logs()
        mask = df.apply(lambda row: row.astype(str).str.contains(keyword, case=False).any(), axis=1)
        return df[mask]

# ==============================
# ğŸ‘· Ù…Ø«Ø§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ø®Ù„ Streamlit
# ==============================
if __name__ == "__main__":
    logs_manager = AILogsManager()

    # ØªØ³Ø¬ÙŠÙ„ Ù…Ø«Ø§Ù„
    logs_manager.log_interaction(
        role="Ø§Ù„Ø¹Ù…Ø§Ù„",
        query="ÙƒÙŠÙ Ø£Ø­Ø³Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ",
        response="ÙŠØ¬Ø¨ Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø§Ø¯Ø© 40 Ù…Ù† Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ.",
        reference="Ø§Ù„Ù…Ø§Ø¯Ø© 40 Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¹Ù…Ù„",
        example="Ø¹Ø§Ù…Ù„ Ø£Ø¬Ø±Ù‡ 500 Ø¯ÙŠÙ†Ø§Ø± ÙˆØ¹Ù…Ù„ 5 Ø³Ù†ÙˆØ§Øª ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© 2500 Ø¯ÙŠÙ†Ø§Ø±",
        notes="âœ… Ù…Ù…ØªØ§Ø²"
    )

    # ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    df = logs_manager.load_logs()
    print(df.head())